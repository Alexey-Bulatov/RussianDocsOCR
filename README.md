# Библиотека распознавания документов РФ

## О проекте
Данный проект реализует библиотеку детекции и распознавания текста на официальных документах РФ. 

Типы поддерживаемых документов:
1) Внутренний паспорт РФ. Версия 1997 года
2) Внутренний паспорт РФ. Версия 2011 года
3) Заграничный паспорт РФ. Версия 2003 года
4) Заграничный паспорт РФ - биометрический. Версия 2007 года
5) Водительские права РФ. Версия 2011 года
6) Водительские права РФ. Версия 2020 года
7) СНИЛС. Версия 1996 года

## Установка библиотеки

Поддерживается Python >= 3.9

#### Клонируем библиотеку:
`git clone https://github.com/protei300/RussianDocsOCR.git`

#### Устаналиваем зависимости:
`pip -r requirements.txt`


## Описание структуры папок
Библиотека состоит из 4 основных папок:
1) `document_processing`. В папке хранятся основные модели, классы их запуска и класс Pipeline.
2) `samples`. В папке хранятся образцы документов каждого из типов (7 типов) с описанием текстовых значений полей
3) `scripts`. В папке хранятся различные полезные скрипты, такие как обработка 1 изображения, видео потока и др. Состав может меняться.
4) `tests`. В папке хранятся юнит-тесты модулей библиотеки 


## Использование библиотеки

### Готовые скрипты
Готовые скрипты хранятся в папке scripts

#### `process_img.py` - Скрипт запускающий конвейер на 1 изображении в формате CLI. 

Параметры:
- `-i`, `--img_path` - путь до изображения
- `-d`, `--device` - какое устройство использовать для инференса. По умолчанию 'cpu'
- `-f`, `--format` - формат моделей для использования. Допускается 'ONNX', 'OpenVINO', 'CoreML'. По умолчанию 'ONNX'
- `--check_quality` - Нужно ли запускать сети качества, по умолчанию False
- `--img_size` - максимальный размер изображения по большей стороне, по умолчанию 1500

Результат работы выводится на экран в формате json

#### `process_video.py` - Скрипт запускающий конвейер на видео потоке с веб-камеры.
Параметры прописываются внутри скрипта.

### Использование основного конвейера библиотеки
#### Класс Pipeline. 
Основной класс реализующий конвейер обработки изображений. При создании объекта необязательными параметрами являются:
- `model_format` - 'ONNX', 'OpenVINO', 'CoreML' 
- `device` - 'cpu', 'gpu'

После создания объекта, в объект передаем изображение. Параметры передаваемые в объект класса Pipeline:
- `img_path` - Путь до изображение в форматах str, Path, либо изображение в формате np.ndarray. 
ВАЖНО! При передаче изображения, как np.ndarray, картинка никак не предобрабатывается кроме ресайза до `img_size` по большей стороне
- `get_doc_borders` - по умолчанию True. Определяет, нужно ли детектировать границы документа на изображении и 
восстанавливать геометрию
- `find_text_fields` - по умолчанию True. Определяет, нужно ли детектировать текстовые поля. Если принимает значение False, 
то работа конвейера после детекции изображения не производится (нет OCR).
- `ocr` - по умолчанию True. Определяет, нужно ли производить распознавание текста внутри найденных текстовых полей
- `check_quality` - по умолчанию True. Определяет, нужно ли запускать модули проверки качества изображения (BLur, Glate, PrintSpoofing, LCDSpoofing)
- `low_quality` - по умолчанию True. Определяет, нужно ли обрабатывать изображения с низким качеством (например, замечен Blue, Glare)
- `docconf` - по умолчанию 0.5. Определяет граничное значение выдаваемое, ниже которого документы отклоняются, как низкого качества. Допустимые значения (0..1)
- `img_size` - максимальный размер изображения по большей стороне, подаваемый на распознавание

Объект Pipeline после окончания работы возвращает объект PipelineResults 

#### PipelineResults
Объект содержит результаты работы конвейера на изображении и обладает рядом удобных свойств для получения информации в удобном виде. 

Основные из них:
- `@property def ocr(self) -> Union[Dict, None]:` - возвращает результат работы конвейера по распознаванию текста в документе в формате словарь
- `@property def doctype(self) -> Union[str, None]:` - возвращает тип документа
- `@property def quality(self) -> dict:` - возвращает всю информацию о качестве документа в формате словарь
- `@property def rotated_image(self) -> np.ndarray:` - возвращает развернутое изображение
- `@property def img_with_fixed_perspective(self) -> Union[list, None]:` - возвращает восстановленное изображение
- `@property def text_fields(self) -> Union[Tuple[list, list], None]:` - возваращает кортеж из координат и классов текстовых полей и лоскутов изображений
- `@property def words_patches(self) -> Union[Dict, None]:` - возвращает словарь в котором ключем является название поля, 
а значения лоскуты слов и их распознанный аналог (если проводился OCR)


#### Пример:
```python
from document_processing import Pipeline

pipeline = Pipeline(model_format='OpenVINO', device='cpu')
result = pipeline(img_path='img.jpg')
print(result.ocr)
```

### Использование отдельных модулей библиотеки
Возможно использование отдельных модулей библиотеки. 

#### Пример:
```python
from document_processing.pipeline_modules import Angle90

angle90 = Angle90(model_format='OpenVINO', device='cpu')
result = angle90.predict(img='img.jpg') # if we want to get only result from net
result_with_warped = angle90.predict_transform(img='img.jpg') # if we want also warp image
```

## Об авторах проекта

### Митянина Анастасия Владимировна 
- email: av.mityanina@zbrsk.ru

### Мельников Виталий Андреевич
- email: protei300@gmail.com

### Валуев Дмитрий Валерьевич
- email: dee-mon@mail.ru

### Карпич Александр Владимирович
- email: avkarpich@gmail.com

### Вохминцев Александр Владиславович
- email: vav@csu.ru

## Поддержка
Данный проект выполнен при финансировании Фондс Содействия Инновациям https://fasie.ru/. 



